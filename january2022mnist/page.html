<!DOCTYPE html>
<html lang="ru">
	<head>
		<title>MNIST</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta charset="utf-8">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mnist/1.1.0/mnist.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
	</head>
	<body>
		<main>
      <p>Урок: <a href="https://youtu.be/eeO-rWYFuG0">https://youtu.be/eeO-rWYFuG0</a></p>
      <p>libraries: <a href="https://p5js.org/">p5.js</a>, <a href="https://github.com/cazala/mnist">mnist.js</a>, <a href="https://ml5js.org/">ml5.js</a></p>
      <p>result: <span id="result">-<span></p>
      <p id="wait">Загрузка...</p>
      <p id="clear"><button onClick="resetCanvas()">Очистить</button><p>
		</main>
		<script>
      const trainingAmount = 100;
      const testAmount = 0;
      let set = mnist.set(trainingAmount, testAmount);
			const w = 200;
			const h = 200;
      const penSize = 20;
      let classifying = false;
      let ready = false;
      let mobilenet, classifier;

			function setup() {
        document.getElementById("clear").style.visibility = "hidden";
        mobilenet = ml5.featureExtractor("MobileNet", modelReady);
        classifier = mobilenet.classification();
				createCanvas(w, h);
			}

			function draw() {
        if (mouseIsPressed) {
          push();
          stroke(255, 255, 255);
          fill(255, 255, 255);
          strokeWeight(penSize);
          line(draw.lastX, draw.lastY, mouseX, mouseY);
          pop();

          if (ready && !classifying) {
            let img = get();
            img.resize(28, 28);
            mobilenet.classify(img.canvas, (e, r) => {
              document.getElementById("result").textContent = e ? e : r[0].label + " with confidence " + r[0].confidence;
              classifying = false;
            })
            classifying = true;
          }
        }
        draw.lastX = mouseX;
        draw.lastY = mouseY;
			}

      function mousePressed() {
        draw.lastX = mouseX;
        draw.lastY = mouseY;
      }

      function resetCanvas() {
        background(0, 0, 0);
      }

      function modelReady() {
        let promises = [];
        for (let d of set.training) {
          promises.push(classifier.addImage(
            ImageFromArray(d.input, 28, 28).canvas,
            d.output.findIndex(v => v === 1).toString()
          ));
        }
        Promise.allSettled(promises).then(() => {
          classifier.train(loss => console.log("loss:", loss)).then(() => {
            ready = true;
            document.getElementById("wait").style.visibility = "hidden";
            document.getElementById("clear").style.visibility = "visible";
            resetCanvas();
          });
        });
      }

      function ImageFromArray(a, w, h) {
        let img = createImage(w, h);
        img.loadPixels();
        for (let i = 0; i < img.width; i++) {
          for (let j = 0; j < img.height; j++) {
            img.set(i, j, color(a[j * w + i] * 255, 255));
          }
        }
        img.updatePixels();
        return img;
      }
		</script>
	</body>
</html>
<!--
<!DOCTYPE html>
<html lang="ru">
	<head>
		<title>MNIST</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta charset="utf-8">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mnist/1.1.0/mnist.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
	</head>
	<body>
		<main>
      <p>Урок: <a href="https://youtu.be/KTNqXwkLuM4">https://youtu.be/KTNqXwkLuM4</a></p>
      <p>libraries: <a href="https://p5js.org/">p5.js</a>, <a href="https://github.com/cazala/mnist">mnist.js</a>, <a href="https://ml5js.org/">ml5.js</a></p>
      <p><button onClick="resetCanvas()">Очистить</button><p>
      <p>result: <span id="result">-<span></p>
		</main>
		<script>
      const trainingAmount = 1000;
      const testAmount = 0;
      let set = mnist.set(trainingAmount, testAmount);
      let features, knn;
			const w = 200;
			const h = 200;
      const penSize = 20;
      let classifying = false;
      let ready = false;

			function setup() {
        features = ml5.featureExtractor("MobileNet", modelReady);
        knn = ml5.KNNClassifier();
				createCanvas(w, h);
			}

			function draw() {
        if (mouseIsPressed) {
          push();
          stroke(255, 255, 255);
          fill(255, 255, 255);
          strokeWeight(penSize);
          line(draw.lastX, draw.lastY, mouseX, mouseY);
          pop();

          if (ready && !classifying) {
            knn.classify(features.infer(get().canvas), (e, r) => {
              document.getElementById("result").textContent = e ? e : r.label;
              classifying = false;
            });
            classifying = true;
          }
        }
        draw.lastX = mouseX;
        draw.lastY = mouseY;
			}

      function mousePressed() {
        draw.lastX = mouseX;
        draw.lastY = mouseY;
      }

      function resetCanvas() {
        background(0, 0, 0);
      }

      function modelReady() {
        for (let d of set.training) {
          knn.addExample(
            features.infer(ImageFromArray(d.input, 28, 28).canvas),
            d.output.findIndex(v => v === 1).toString()
          );
        }
        ready = true;
        resetCanvas();
      }

      function ImageFromArray(a, w, h) {
        let img = createImage(w, h);
        img.loadPixels();
        for (let i = 0; i < img.width; i++) {
          for (let j = 0; j < img.height; j++) {
            img.set(i, j, color(a[j * w + i] * 255, 255));
          }
        }
        img.updatePixels();
        return img;
      }
		</script>
	</body>
</html>
-->
